<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Prescription list View -->
        <record id="view_clinic_prescription_list" model="ir.ui.view">
            <field name="name">clinic.prescription.list</field>
            <field name="model">clinic.prescription</field>
            <field name="arch" type="xml">
                <list string="Prescriptions" sample="1" decoration-info="state == 'draft'"
                      decoration-success="state == 'confirmed'" decoration-warning="controlled_substances == True">
                    <field name="prescription_number"/>
                    <field name="prescription_date"/>
                    <field name="patient_id"/>
                    <field name="prescriber_id"/>
                    <field name="total_medications"/>
                    <field name="controlled_substances"/>
                    <field name="state"/>
                    <field name="dispensed_date"/>
                </list>
            </field>
        </record>

        <!-- Prescription line list View -->
        <record id="view_clinic_prescription_line_list" model="ir.ui.view">
            <field name="name">clinic.prescription.line.list</field>
            <field name="model">clinic.prescription.line</field>
            <field name="arch" type="xml">
                <list string="Prescriptions" sample="1"  decoration-warning="is_controlled_substance == True">
                    <field name="prescription_id"/>
                    <field name="is_controlled_substance"/>
                    <field name="stop_date"/>
                </list>
            </field>
        </record>

        <!-- Prescription Form View -->
        <record id="view_clinic_prescription_form" model="ir.ui.view">
            <field name="name">clinic.prescription.form</field>
            <field name="model">clinic.prescription</field>
            <field name="arch" type="xml">
                <form string="Prescription">
                    <header>
                        <button name="action_confirm" type="object"
                                string="Confirm Prescription" class="btn-primary"
                                invisible="state != 'draft'"/>
                        <button name="action_print_prescription" type="object"
                                string="Print Prescription" class="btn-primary"
                                invisible ="state == 'draft'"/>
                        <button name="action_transmit_electronically" type="object"
                                string="Send to Pharmacy" class="btn-secondary"
                                invisible="state != 'confirmed'"/>
                        <button name="action_mark_dispensed" type="object"
                                string="Mark as Dispensed" class="btn-secondary"
                                invisible="state != 'confirmed'"/>
                        <button name="duplicate_prescription" type="object"
                                string="Create Refill" class="btn-secondary"
                                invisible="state != 'confirmed' and refills_remaining == 0"/>
                        <button name="action_cancel" type="object"
                                string="Cancel" class="btn-secondary"
                                ainvisible= "state in ['cancelled', 'dispensed']"/>
                        <field name="state" widget="statusbar" statusbar_visible="draft,confirmed,dispensed"/>
                    </header>
                    <sheet>
                        <div class="oe_title">
                            <h1>
                                <field name="prescription_number" readonly="1"/>
                            </h1>
                            <h2>
                                <field name="patient_id" options="{'no_create': True, 'no_create_edit': True}" required="1"/>
                            </h2>
                        </div>

                        <group>
                            <group name="prescription_info" string="Prescription Information">
                                <field name="prescription_date"/>
                                <field name="prescriber_id" options="{'no_create': True}" required="1"/>
                                <field name="prescriber_license" readonly="1"/>
                                <field name="prescriber_dea" readonly="1"
                                       invisible= "controlled_substances == False"/>
                                <field name="vital_signs_id" domain="[('patient_id', '=', patient_id)]"/>
                            </group>
                            <group name="clinical_context" string="Clinical Context">
                                <field name="diagnosis_codes"/>
                                <field name="clinical_indication"/>
                                <field name="patient_weight"/>
                                <field name="pregnancy_status"
                                       invisible=" patient_id.gender  != 'female'"/>
                                <field name="generic_substitution"/>
                            </group>
                        </group>

                        <group name="patient_safety" string="Patient Safety Information">
                            <field name="allergies_noted" readonly="1"/>
                        </group>

                        <notebook>
                            <page name="medications" string="Medications">
                                <field name="prescription_line_ids">
                                    <list string="Prescribed Medications" editable="bottom">
                                        <field name="sequence" widget="handle"/>
                                        <field name="medication_id"
                                               options="{'no_create': True, 'no_create_edit': True}"
                                               domain="[('active', '=', True)]"/>
                                        <field name="strength_prescribed"/>
                                        <field name="dosage_form_prescribed"/>
                                        <field name="dose_amount"/>
                                        <field name="frequency"/>
                                        <field name="frequency_text"
                                               invisible= "frequency != 'custom'" required= "frequency == 'custom'"/>
                                        <field name="duration"/>
                                        <field name="quantity_prescribed"/>
                                        <field name="quantity_unit"/>
                                        <field name="refills_authorized"/>
                                        <field name="special_instructions"/>
                                        <field name="is_controlled_substance" invisible="1"/>
                                        <field name="controlled_schedule"
                                               invisible = "is_controlled_substance == False"/>
                                    </list>
                                    <form string="Medication Line">
                                        <group>
                                            <group name="medication_info" string="Medication">
                                                <field name="medication_id"
                                                       options="{'no_create': True, 'no_create_edit': True}"
                                                       domain="[('active', '=', True)]"/>
                                                <field name="strength_prescribed"/>
                                                <field name="dosage_form_prescribed"/>
                                                <field name="route"/>
                                            </group>
                                            <group name="dosing_info" string="Dosing">
                                                <field name="dose_amount"/>
                                                <field name="frequency"/>
                                                <field name="frequency_text"
                                                       invisible=" frequency != 'custom'" required="frequency == 'custom'"/>
                                                <field name="duration"/>
                                                <field name="duration_days"/>
                                            </group>
                                        </group>

                                        <group>
                                            <group name="quantity_info" string="Quantity &amp; Refills">
                                                <field name="quantity_prescribed"/>
                                                <field name="quantity_unit"/>
                                                <field name="calculated_quantity" readonly="1"/>
                                                <field name="days_supply"/>
                                                <field name="refills_authorized"/>
                                                <field name="generic_substitution_allowed"/>
                                            </group>
                                            <group name="safety_checks" string="Safety Checks">
                                                <field name="allergy_checked"/>
                                                <field name="drug_interaction_checked"/>
                                                <field name="dose_range_checked"/>
                                                <field name="duplicate_therapy_checked"/>
                                                <field name="is_controlled_substance" readonly="1"/>
                                                <field name="controlled_schedule" readonly="1"
                                                       invisible= "is_controlled_substance == False"/>
                                            </group>
                                        </group>

                                        <group name="instructions" string="Instructions &amp; Monitoring">
                                            <field name="special_instructions"
                                                   placeholder="e.g., Take with food, Take at bedtime, Avoid alcohol..."/>
                                            <field name="patient_counseling"
                                                   placeholder="Important patient education points..."/>
                                            <field name="monitoring_required"
                                                   placeholder="Required monitoring (e.g., Monitor blood pressure, Check liver function)..."/>
                                            <field name="stop_date"/>
                                        </group>
                                    </form>
                                </field>

                                <group name="prescription_summary" string="Prescription Summary">
                                    <group>
                                        <field name="total_medications" readonly="1"/>
                                        <field name="controlled_substances" readonly="1"/>
                                        <field name="refills_remaining" readonly="1"/>
                                    </group>
                                </group>
                            </page>

                            <page name="instructions" string="Instructions &amp; Notes">
                                <group>
                                    <field name="special_instructions"
                                           placeholder="Additional instructions for patient or pharmacist..."/>
                                    <field name="follow_up_date"/>
                                    <field name="notes"
                                           placeholder="Internal notes not printed on prescription..."/>
                                </group>
                            </page>

                            <page name="dispensing" string="Dispensing Information">
                                <group>
                                    <group name="pharmacy_info" string="Pharmacy Information">
                                        <field name="dispensing_pharmacy"/>
                                        <field name="dispensed_date" readonly="1"/>
                                        <field name="printed" readonly="1"/>
                                        <field name="transmitted" readonly="1"/>
                                    </group>
                                    <group name="signature_info" string="Electronic Signature">
                                        <field name="electronic_signature" readonly="1"/>
                                        <field name="signature_timestamp" readonly="1"/>
                                    </group>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                    <chatter/>
                    <!-- <div class="oe_chatter">
                        <field name="message_follower_ids"/>
                        <field name="activity_ids"/>
                        <field name="message_ids"/>
                    </div> -->
                </form>
            </field>
        </record>

        <!-- Prescription Search View
        <record id="view_clinic_prescription_search" model="ir.ui.view">
            <field name="name">clinic.prescription.search</field>
            <field name="model">clinic.prescription</field>
            <field name="arch" type="xml">
                <search string="Search Prescriptions">
                    <field name="prescription_number"/>
                    <field name="patient_id" string="Patient"/>
                    <field name="prescriber_id" string="Prescriber"/>
                    <field name="diagnosis_codes" string="Diagnosis"/>
                    <field name="clinical_indication" string="Indication"/>

                    <filter name="draft" string="Draft"
                            domain="[('state', '=', 'draft')]"/>
                    <filter name="confirmed" string="Confirmed"
                            domain="[('state', '=', 'confirmed')]"/>
                    <filter name="dispensed" string="Dispensed"
                            domain="[('state', '=', 'dispensed')]"/>
                    <filter name="cancelled" string="Cancelled"
                            domain="[('state', '=', 'cancelled')]"/>

                    <separator/>
                    <filter name="controlled_substances" string="Controlled Substances"
                            domain="[('controlled_substances', '=', True)]"/>
                    <filter name="non_controlled" string="Non-Controlled"
                            domain="[('controlled_substances', '=', False)]"/>

                    <separator/>
                    <filter name="today" string="Today"
                            domain="[('prescription_date', '>=', datetime.datetime.combine(context_today(), datetime.time(0,0,0))), ('prescription_date', '&lt;=', datetime.datetime.combine(context_today(), datetime.time(23,59,59)))]"/>
                    <filter name="this_week" string="This Week"
                            domain="[('prescription_date', '>=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')), ('prescription_date', '&lt;=', (context_today() + datetime.timedelta(days=6-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                    <filter name="this_month" string="This Month"
                            domain="[('prescription_date', '>=', context_today().replace(day=1).strftime('%Y-%m-%d')), ('prescription_date', '&lt;=', (context_today().replace(day=1) + datetime.timedelta(days=32)).replace(day=1) - datetime.timedelta(days=1)).strftime('%Y-%m-%d'))]"/>

                    <separator/>
                    <filter name="printed" string="Printed"
                            domain="[('printed', '=', True)]"/>
                    <filter name="transmitted" string="Transmitted"
                            domain="[('transmitted', '=', True)]"/>
                    <filter name="has_refills" string="Has Refills"
                            domain="[('refills_remaining', '>', 0)]"/>

                    <group expand="0" string="Group By">
                        <filter name="group_by_patient" string="Patient"
                                context="{'group_by': 'patient_id'}"/>
                        <filter name="group_by_prescriber" string="Prescriber"
                                context="{'group_by': 'prescriber_id'}"/>
                        <filter name="group_by_state" string="Status"
                                context="{'group_by': 'state'}"/>
                        <filter name="group_by_date" string="Date"
                                context="{'group_by': 'prescription_date:day'}"/>
                    </group>
                </search>
            </field>
        </record> -->



        <!-- Prescription Search View -->
        <record id="view_clinic_prescription_search" model="ir.ui.view">
            <field name="name">clinic.prescription.search</field>
            <field name="model">clinic.prescription</field>
            <field name="arch" type="xml">
                <search string="Search Prescriptions">
                    <field name="prescription_number"/>
                    <field name="patient_id" string="Patient"/>
                    <field name="prescriber_id" string="Prescriber"/>
                    <field name="diagnosis_codes" string="Diagnosis"/>
                    <field name="clinical_indication" string="Indication"/>

                    <!-- Status Filters -->
                    <filter name="draft" string="Draft" domain="[('state', '=', 'draft')]"/>
                    <filter name="confirmed" string="Confirmed" domain="[('state', '=', 'confirmed')]"/>
                    <filter name="dispensed" string="Dispensed" domain="[('state', '=', 'dispensed')]"/>
                    <filter name="cancelled" string="Cancelled" domain="[('state', '=', 'cancelled')]"/>

                    <separator/>

                    <!-- Controlled Substance Filters -->
                    <filter name="controlled_substances" string="Controlled Substances" domain="[('controlled_substances', '=', True)]"/>
                    <filter name="non_controlled" string="Non-Controlled" domain="[('controlled_substances', '=', False)]"/>

                    <separator/>

                    <!-- Date Filters -->
                    <!-- <filter name="today" string="Today" domain="[('prescription_date', '=', context_today())]"/> -->
                    <!-- <filter name="this_week" string="This Week" domain="[('prescription_date', '&gt;=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%%Y-%%m-%%d')), ('prescription_date', '&lt;=', (context_today() + datetime.timedelta(days=6-context_today().weekday())).strftime('%%Y-%%m-%%d'))]"/> -->
                    <!-- <filter string="This Week" domain="[('prescription_date','&gt;=', (context_today() - datetime.timedelta(days=context_today().weekday()))), ('prescription_date','&lt;=', (context_today() + datetime.timedelta(days=6 - context_today().weekday())))]" /> -->

                    <!-- <filter name="this_month" string="This Month" domain="[('prescription_date', '&gt;=', context_today().replace(day=1)), ('prescription_date', '&lt;', (context_today().replace(day=1) + relativedelta(months=1)))]"/> -->

                    <separator/>

                    <!-- Additional Flags -->
                    <filter name="printed" string="Printed" domain="[('printed', '=', True)]"/>
                    <filter name="transmitted" string="Transmitted" domain="[('transmitted', '=', True)]"/>
                    <!-- <filter name="has_refills" string="Has Refills" domain="[('refills_remaining', '>', 0)]"/> -->

                    <!-- Group By -->
                    <group expand="0" string="Group By">
                        <filter name="group_by_patient" string="Patient" context="{'group_by': 'patient_id'}"/>
                        <filter name="group_by_prescriber" string="Prescriber" context="{'group_by': 'prescriber_id'}"/>
                        <filter name="group_by_state" string="Status" context="{'group_by': 'state'}"/>
                        <filter name="group_by_date" string="Date" context="{'group_by': 'prescription_date:day'}"/>
                    </group>
                </search>
            </field>
        </record>



        <!-- Prescription Calendar View -->
        <!-- <record id="view_clinic_prescription_calendar" model="ir.ui.view">
            <field name="name">clinic.prescription.calendar</field>
            <field name="model">clinic.prescription</field>
            <field name="arch" type="xml">
                <calendar string="Prescriptions" date_start="prescription_date" color="state" quick_add="False">
                    <field name="patient_id" />
                    <field name="prescriber_id"/>
                    <field name="state"/>
                </calendar>
            </field>
        </record> -->

        <!-- Prescription Pivot View -->
        <record id="view_clinic_prescription_pivot" model="ir.ui.view">
            <field name="name">clinic.prescription.pivot</field>
            <field name="model">clinic.prescription</field>
            <field name="arch" type="xml">
                <pivot string="Prescription Analysis">
                    <field name="prescription_date" type="row" interval="month"/>
                    <field name="prescriber_id" type="col"/>
                    <field name="total_medications" type="measure"/>
                    <field name="controlled_substances" type="measure"/>
                </pivot>
            </field>
        </record>

        <!-- Prescription Action -->
        <record id="action_clinic_prescription" model="ir.actions.act_window">
            <field name="name">Prescriptions</field>
            <field name="res_model">clinic.prescription</field>
            <field name="view_mode">list,form,pivot</field>
            <field name="search_view_id" ref="view_clinic_prescription_search"/>
            <field name="context">{'search_default_this_week': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first prescription
                </p>
                <p>
                    Start prescribing medications for your patients with comprehensive
                    safety checks, drug interaction warnings, and automatic clinical
                    decision support. All prescriptions include vital signs integration
                    and printable reports.
                </p>
            </field>
        </record>

    </data>
</odoo>

